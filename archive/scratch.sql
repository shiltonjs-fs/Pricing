--by card, next day, GTV tier
with
    MAIN as (
        select
            DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) as MONTH_TRANSACTED,
            CARDUP_PAYMENT_CUSTOMER_COMPANY_ID as COMPANY_ID,
            case
                when CARDUP_PAYMENT_CARD_TYPE = '' then 'Bank Transfer'
                else CARDUP_PAYMENT_CARD_TYPE
            end as CARD_TYPE,
            INDUSTRY,
            case
                when CARDUP_PAYMENT_NEXT_DAY_FEE > 0 then 1
                else 0
            end as NEXT_DAY,
            SUM(CARDUP_PAYMENT_USD_AMT) as TOTAL_GTV,
            --SUM(CARDUP_PAYMENT_TOTAL_REVENUE_USD_AMT) as TOTAL_REVENUE,
            SUM(CARDUP_PAYMENT_NET_REVENUE_USD_AMT) as TOTAL_NET_REVENUE,
            --sum(CARDUP_PAYMENT_CARDUP_FEE/(CARDUP_PAYMENT_LCL_AMT/CARDUP_PAYMENT_USD_AMT)) as TOTAL_CARDUP_FEE,
            ROUND(
                SUM(CARDUP_PAYMENT_CARDUP_FEE / (CARDUP_PAYMENT_LCL_AMT / CARDUP_PAYMENT_USD_AMT)) / SUM(CARDUP_PAYMENT_USD_AMT),
                4
            ) as CARDUP_FEE_RATE,
            SUM(CARDUP_PAYMENT_TOTAL_COST_USD_AMT) / SUM(CARDUP_PAYMENT_USD_AMT) as COST_RATE
        from
            ADM.TRANSACTION.CARDUP_PAYMENT_DENORM_T T1
            inner join (
                select distinct
                    CU_COMPANY_ID,
                    CU_COMPANY_L1_INDUSTRY INDUSTRY
                from
                    CDM.COUNTERPARTY.CARDUP_COMPANY_T
                where
                    COMPANY_CU_LOCALE_ID = 1
            ) T2 on T1.CARDUP_PAYMENT_CUSTOMER_COMPANY_ID = T2.CU_COMPANY_ID
        WHERE
            CARDUP_PAYMENT_STATUS NOT IN ('Payment Failed', 'Cancelled', 'Refunded', 'Refunding')
            --AND CARDUP_PAYMENT_USER_TYPE IN ('business', 'guest')
            AND CARDUP_PAYMENT_USER_TYPE IN ('business')
            and CARDUP_PAYMENT_CU_LOCALE_ID = 1
            and LOWER(CARDUP_PAYMENT_PRODUCT_NAME) LIKE '%make%'
            and DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) >= DATE('2023-01-01')
            and CARDUP_PAYMENT_SALES_OWNER is not null
        group by
            1,
            2,
            3,
            4,
            5
    ),
    MAIN_WITH_TIER as (
        select
            *,
            case
                when TOTAL_GTV < 10000 then '01. $0-10,000'
                when TOTAL_GTV < 20000 then '01. $10-20,000'
                when TOTAL_GTV < 30000 then '01. $20-30,000'
                when TOTAL_GTV < 40000 then '01. $30-40,000'
                when TOTAL_GTV < 50000 then '01. $40-50,000'
                when TOTAL_GTV < 60000 then '01. $50-60,000'
                when TOTAL_GTV < 70000 then '01. $60-70,000'
                when TOTAL_GTV < 80000 then '01. $70-80,000'
                when TOTAL_GTV < 90000 then '01. $80-90,000'
                when TOTAL_GTV < 100000 then '01. $90-100,000'
                when TOTAL_GTV < 110000 then '02. $100-110,000'
                when TOTAL_GTV < 120000 then '02. $110-120,000'
                when TOTAL_GTV < 130000 then '02. $120-130,000'
                when TOTAL_GTV < 140000 then '02. $130-140,000'
                when TOTAL_GTV < 150000 then '02. $140-150,000'
                when TOTAL_GTV < 160000 then '02. $150-160,000'
                when TOTAL_GTV < 170000 then '02. $160-170,000'
                when TOTAL_GTV < 180000 then '02. $170-180,000'
                when TOTAL_GTV < 190000 then '02. $180-190,000'
                when TOTAL_GTV < 200000 then '02. $190-200,000'
                when TOTAL_GTV >= 200000 then '02. $200,000 or more'
                else null
            end as GTV_BUCKET
        from
            MAIN
        where
            TOTAL_GTV != 0
            and CARDUP_FEE_RATE != 0
            and COST_RATE != 0
    ),
    CUSTOMERS_WITH_FEE_CHANGE as (
        select
            COMPANY_ID,
            COUNT(distinct CARDUP_FEE_RATE) COUNT_UNIQUE_FEE
        from
            MAIN_WITH_TIER
        group by
            1
        having
            COUNT_UNIQUE_FEE > 1
    )
select
    *
from
    MAIN_WITH_TIER
where
    true
    and COMPANY_ID in (
        select distinct
            COMPANY_ID
        from
            CUSTOMERS_WITH_FEE_CHANGE
    )
    and CARD_TYPE = 'Visa';

with
    INDUSTRY_TABLE as (
        select distinct
            CU_COMPANY_ID,
            CU_COMPANY_L1_INDUSTRY INDUSTRY
        from
            CDM.COUNTERPARTY.CARDUP_COMPANY_T
        where
            COMPANY_CU_LOCALE_ID = 1
    )
select
    case
        when CARDUP_PAYMENT_SALES_OWNER is null then 'Unmanaged'
        else 'Managed'
    end as SALES_OWNERSHIP,
    COUNT(distinct CARDUP_PAYMENT_CUSTOMER_COMPANY_ID) as COMPANY_ID_COUNT,
from
    ADM.TRANSACTION.CARDUP_PAYMENT_DENORM_T T1
    inner join INDUSTRY_TABLE T2 on T1.CARDUP_PAYMENT_CUSTOMER_COMPANY_ID = T2.CU_COMPANY_ID
WHERE
    CARDUP_PAYMENT_STATUS NOT IN ('Payment Failed', 'Cancelled', 'Refunded', 'Refunding')
    AND CARDUP_PAYMENT_USER_TYPE IN ('business')
    and CARDUP_PAYMENT_CU_LOCALE_ID = 1
    and LOWER(CARDUP_PAYMENT_PRODUCT_NAME) LIKE '%make%'
    --and CARDUP_PAYMENT_SALES_OWNER is not null
    and DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) <= DATE('2025-01-01')
    and DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) >= DATE('2023-01-01')
    and CARDUP_PAYMENT_CARD_TYPE in ('Visa', 'Mastercard')
    and INDUSTRY is not null
group by
    1;

select
    CARDUP_PAYMENT_CUSTOMER_COMPANY_ID,
    CARDUP_PAYMENT_SALES_OWNER,
    max(DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS))) as LATEST_MONTH,
    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2025-01-01') and date('2025-01-01') then CARDUP_PAYMENT_USD_AMT else null end) as TOTAL_GTV_P1M,
    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2024-11-01') and date('2025-01-01') then CARDUP_PAYMENT_USD_AMT else null end) as TOTAL_GTV_P3M,
    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2024-08-01') and date('2025-01-01') then CARDUP_PAYMENT_USD_AMT else null end) as TOTAL_GTV_P6M,
    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2024-02-01') and date('2025-01-01') then CARDUP_PAYMENT_USD_AMT else null end) as TOTAL_GTV_P12M,
    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2023-02-01') and date('2025-01-01') then CARDUP_PAYMENT_USD_AMT else null end) as TOTAL_GTV_P24M,

    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2025-01-01') and date('2025-01-01') then CARDUP_PAYMENT_NET_REVENUE_USD_AMT else null end) as TOTAL_NR_P1M,
    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2024-11-01') and date('2025-01-01') then CARDUP_PAYMENT_NET_REVENUE_USD_AMT else null end) as TOTAL_NR_P3M,
    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2024-08-01') and date('2025-01-01') then CARDUP_PAYMENT_NET_REVENUE_USD_AMT else null end) as TOTAL_NR_P6M,
    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2024-02-01') and date('2025-01-01') then CARDUP_PAYMENT_NET_REVENUE_USD_AMT else null end) as TOTAL_NR_P12M,
    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2023-02-01') and date('2025-01-01') then CARDUP_PAYMENT_NET_REVENUE_USD_AMT else null end) as TOTAL_NR_P24M,

    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2025-01-01') and date('2025-01-01') then (CARDUP_PAYMENT_CARDUP_FEE / (CARDUP_PAYMENT_LCL_AMT / CARDUP_PAYMENT_USD_AMT)) else null end) as TOTAL_FEE_P1M,
    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2024-11-01') and date('2025-01-01') then (CARDUP_PAYMENT_CARDUP_FEE / (CARDUP_PAYMENT_LCL_AMT / CARDUP_PAYMENT_USD_AMT)) else null end) as TOTAL_FEE_P3M,
    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2024-08-01') and date('2025-01-01') then (CARDUP_PAYMENT_CARDUP_FEE / (CARDUP_PAYMENT_LCL_AMT / CARDUP_PAYMENT_USD_AMT)) else null end) as TOTAL_FEE_P6M,
    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2024-02-01') and date('2025-01-01') then (CARDUP_PAYMENT_CARDUP_FEE / (CARDUP_PAYMENT_LCL_AMT / CARDUP_PAYMENT_USD_AMT)) else null end) as TOTAL_FEE_P12M,
    SUM(case when DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) between date('2023-02-01') and date('2025-01-01') then (CARDUP_PAYMENT_CARDUP_FEE / (CARDUP_PAYMENT_LCL_AMT / CARDUP_PAYMENT_USD_AMT)) else null end) as TOTAL_FEE_P24M,

from
    ADM.TRANSACTION.CARDUP_PAYMENT_DENORM_T
WHERE
    CARDUP_PAYMENT_STATUS NOT IN ('Payment Failed', 'Cancelled', 'Refunded', 'Refunding')
    AND CARDUP_PAYMENT_USER_TYPE IN ('business')
    and LOWER(CARDUP_PAYMENT_PRODUCT_NAME) LIKE '%make%'
    and DATE(DATE_TRUNC('month', CARDUP_PAYMENT_CREATED_AT_LCL_TS)) <= DATE('2025-02-01')
    and CARDUP_PAYMENT_CU_LOCALE_ID = 1
    and CARDUP_PAYMENT_CUSTOMER_COMPANY_ID in (
        '4178',
        '3887',
        '2910',
        '4216',
        '4037',
        '2856',
        '2778',
        '4493',
        '3521',
        '914',
        '3945',
        '3382',
        '3926',
        '2967',
        '2819',
        '3905',
        '3664',
        '3409',
        '1139',
        '3842',
        '874',
        '4244',
        '3827',
        '1193',
        '2106',
        '4495',
        '4081',
        '1649',
        '3135',
        '495',
        '3580',
        '4097',
        '3987',
        '3072',
        '1844',
        '4510',
        '2862',
        '830',
        '4094',
        '3583',
        '1182',
        '1431',
        '669',
        '2427',
        '4168',
        '2844',
        '566',
        '3741',
        '3467',
        '4459',
        '3727',
        '4349',
        '3886',
        '4213',
        '2841',
        '2081',
        '4496',
        '2897',
        '4221',
        '2951',
        '3492',
        '768',
        '3660',
        '3629',
        '2644',
        '3008',
        '3422',
        '4230',
        '3778',
        '1443',
        '3434',
        '844',
        '3289',
        '3183',
        '4038',
        '4269',
        '3109',
        '3639',
        '3653',
        '3457',
        '4602',
        '4521',
        '3992',
        '3846',
        '3510',
        '4574',
        '2663',
        '3870',
        '4451',
        '4526',
        '3815',
        '4167',
        '1789',
        '1442',
        '1409',
        '3838',
        '2902',
        '3736',
        '3189',
        '3650',
        '2371',
        '3767',
        '2302',
        '3799',
        '2797',
        '1740',
        '4614',
        '414',
        '4307',
        '2556',
        '4474',
        '4124',
        '3930',
        '210',
        '3857',
        '4233',
        '4095',
        '3779',
        '3601',
        '4126',
        '2858',
        '4666',
        '3390',
        '85',
        '3897',
        '4210',
        '4311',
        '2896',
        '2822',
        '4136',
        '4084',
        '4642',
        '2410',
        '3773',
        '3068',
        '3285',
        '3182',
        '3678',
        '3483',
        '2906',
        '2779',
        '4321',
        '4595',
        '632',
        '3826',
        '793',
        '3925',
        '3775',
        '4260',
        '2387',
        '4138',
        '616',
        '3929',
        '4057',
        '978',
        '3401',
        '3460',
        '805',
        '2894',
        '3791',
        '2025',
        '3171',
        '4177',
        '3851',
        '4032',
        '2667',
        '4062',
        '2075',
        '3640',
        '1751',
        '4047',
        '2893',
        '3902',
        '405',
        '3966',
        '2536',
        '3087',
        '1003',
        '4626',
        '4514',
        '2677',
        '489',
        '3651',
        '2267',
        '451',
        '4016',
        '2127',
        '4302',
        '3306',
        '3086',
        '4330',
        '3446',
        '3688',
        '1746',
        '2335',
        '3814',
        '3174',
        '3048',
        '3395',
        '3967',
        '3798',
        '3524',
        '4206',
        '4563',
        '2534',
        '3286',
        '3607',
        '4494',
        '630',
        '843',
        '4362',
        '3310',
        '4338',
        '4226',
        '3908',
        '369',
        '4399',
        '3267',
        '3965',
        '4054',
        '1370',
        '2507',
        '3564',
        '4360',
        '4174',
        '590',
        '3606',
        '3743',
        '1456',
        '3554',
        '4078',
        '3931',
        '3040',
        '3059',
        '2845',
        '3709',
        '3421',
        '3033',
        '3254',
        '1732',
        '3165',
        '3546',
        '3934',
        '4254',
        '3313',
        '3958',
        '2645',
        '2477',
        '4219',
        '3545',
        '4675',
        '4294',
        '980',
        '4662',
        '3547',
        '2973',
        '2754',
        '4208',
        '1026',
        '1268',
        '3752',
        '3760',
        '2296',
        '344',
        '3695',
        '2694',
        '2722',
        '1784',
        '3244',
        '4383',
        '3024',
        '3573',
        '4012',
        '3667',
        '2249',
        '4193',
        '2244',
        '4317',
        '3260',
        '3348',
        '3711',
        '723',
        '1628',
        '4288',
        '1066',
        '1895',
        '3707',
        '4086',
        '2308',
        '3419',
        '3720',
        '4599',
        '4308',
        '3001',
        '3649',
        '3441',
        '3357',
        '3237',
        '1583',
        '3644',
        '3301',
        '4209',
        '4218',
        '62',
        '4622',
        '3556',
        '4215',
        '3882',
        '1460',
        '3555',
        '104',
        '4303',
        '3816',
        '2342',
        '4447',
        '436',
        '4090',
        '3345',
        '3538',
        '2562',
        '4194',
        '4357',
        '3283',
        '3768',
        '3178',
        '2959',
        '3534',
        '3258',
        '3890',
        '2607',
        '2618',
        '3687',
        '2235',
        '2260',
        '2867',
        '4304',
        '2252',
        '3505',
        '784',
        '3812',
        '2737',
        '2256'
    )
group by
    1, 2;

select
    T1.*,
    T2.ENTITY_NAME
from
    CDM.COUNTERPARTY.CARDUP_COMPANY_T T1
    left join DEV.SBOX_ADITHYA.SG_GOV_ACRA T2 on T1.CU_COMPANY_UEN = T2.UEN
where
    COMPANY_CU_LOCALE_ID = 1
    and CU_COMPANY_ID in (
        '4178',
        '3887',
        '2910',
        '4216',
        '4037',
        '2856',
        '2778',
        '4493',
        '3521',
        '914',
        '3945',
        '3382',
        '3926',
        '2967',
        '2819',
        '3905',
        '3664',
        '3409',
        '1139',
        '3842',
        '874',
        '4244',
        '3827',
        '1193',
        '2106',
        '4495',
        '4081',
        '1649',
        '3135',
        '495',
        '3580',
        '4097',
        '3987',
        '3072',
        '1844',
        '4510',
        '2862',
        '830',
        '4094',
        '3583',
        '1182',
        '1431',
        '669',
        '2427',
        '4168',
        '2844',
        '566',
        '3741',
        '3467',
        '4459',
        '3727',
        '4349',
        '3886',
        '4213',
        '2841',
        '2081',
        '4496',
        '2897',
        '4221',
        '2951',
        '3492',
        '768',
        '3660',
        '3629',
        '2644',
        '3008',
        '3422',
        '4230',
        '3778',
        '1443',
        '3434',
        '844',
        '3289',
        '3183',
        '4038',
        '4269',
        '3109',
        '3639',
        '3653',
        '3457',
        '4602',
        '4521',
        '3992',
        '3846',
        '3510',
        '4574',
        '2663',
        '3870',
        '4451',
        '4526',
        '3815',
        '4167',
        '1789',
        '1442',
        '1409',
        '3838',
        '2902',
        '3736',
        '3189',
        '3650',
        '2371',
        '3767',
        '2302',
        '3799',
        '2797',
        '1740',
        '4614',
        '414',
        '4307',
        '2556',
        '4474',
        '4124',
        '3930',
        '210',
        '3857',
        '4233',
        '4095',
        '3779',
        '3601',
        '4126',
        '2858',
        '4666',
        '3390',
        '85',
        '3897',
        '4210',
        '4311',
        '2896',
        '2822',
        '4136',
        '4084',
        '4642',
        '2410',
        '3773',
        '3068',
        '3285',
        '3182',
        '3678',
        '3483',
        '2906',
        '2779',
        '4321',
        '4595',
        '632',
        '3826',
        '793',
        '3925',
        '3775',
        '4260',
        '2387',
        '4138',
        '616',
        '3929',
        '4057',
        '978',
        '3401',
        '3460',
        '805',
        '2894',
        '3791',
        '2025',
        '3171',
        '4177',
        '3851',
        '4032',
        '2667',
        '4062',
        '2075',
        '3640',
        '1751',
        '4047',
        '2893',
        '3902',
        '405',
        '3966',
        '2536',
        '3087',
        '1003',
        '4626',
        '4514',
        '2677',
        '489',
        '3651',
        '2267',
        '451',
        '4016',
        '2127',
        '4302',
        '3306',
        '3086',
        '4330',
        '3446',
        '3688',
        '1746',
        '2335',
        '3814',
        '3174',
        '3048',
        '3395',
        '3967',
        '3798',
        '3524',
        '4206',
        '4563',
        '2534',
        '3286',
        '3607',
        '4494',
        '630',
        '843',
        '4362',
        '3310',
        '4338',
        '4226',
        '3908',
        '369',
        '4399',
        '3267',
        '3965',
        '4054',
        '1370',
        '2507',
        '3564',
        '4360',
        '4174',
        '590',
        '3606',
        '3743',
        '1456',
        '3554',
        '4078',
        '3931',
        '3040',
        '3059',
        '2845',
        '3709',
        '3421',
        '3033',
        '3254',
        '1732',
        '3165',
        '3546',
        '3934',
        '4254',
        '3313',
        '3958',
        '2645',
        '2477',
        '4219',
        '3545',
        '4675',
        '4294',
        '980',
        '4662',
        '3547',
        '2973',
        '2754',
        '4208',
        '1026',
        '1268',
        '3752',
        '3760',
        '2296',
        '344',
        '3695',
        '2694',
        '2722',
        '1784',
        '3244',
        '4383',
        '3024',
        '3573',
        '4012',
        '3667',
        '2249',
        '4193',
        '2244',
        '4317',
        '3260',
        '3348',
        '3711',
        '723',
        '1628',
        '4288',
        '1066',
        '1895',
        '3707',
        '4086',
        '2308',
        '3419',
        '3720',
        '4599',
        '4308',
        '3001',
        '3649',
        '3441',
        '3357',
        '3237',
        '1583',
        '3644',
        '3301',
        '4209',
        '4218',
        '62',
        '4622',
        '3556',
        '4215',
        '3882',
        '1460',
        '3555',
        '104',
        '4303',
        '3816',
        '2342',
        '4447',
        '436',
        '4090',
        '3345',
        '3538',
        '2562',
        '4194',
        '4357',
        '3283',
        '3768',
        '3178',
        '2959',
        '3534',
        '3258',
        '3890',
        '2607',
        '2618',
        '3687',
        '2235',
        '2260',
        '2867',
        '4304',
        '2252',
        '3505',
        '784',
        '3812',
        '2737',
        '2256'
    );


select cu_company_id, cu_company_l1_industry from cdm.counterparty.cardup_company_t limit 10;

select * from ADM.TRANSACTION.CARDUP_PAYMENT_DENORM_T where CARDUP_PAYMENT_PROMO_CODE_TAG = 'Special Pricing' and cardup_payment_promo_code is null limit 10;

select * from ADM.TRANSACTION.CARDUP_PAYMENT_DENORM_T limit 10;

select * from CDM.COUNTERPARTY.CARDUP_COMPANY_T limit 10;